# 4.7-Filling the bucket - WIP

We'll need a specific hierarchy of folders and files in our S3 bucket, so that the bootstrap script \(enabling our OpenVPN server auto-configuration at startup\) find all the required elements to do its job.

**We'll first prepare this entire hierarchy locally, so that we can :**

* **easily check/edit/recheck** our file contents and the names of all files and sub-folders
* use both transfer options :
  * **manually transfer** our files with AWS S3 console
  * **use batch transfer/synching tools** like [CloudBerry Explorer for Amazon S3](../proposed-solution/tools.md#cloudberry-explorer-for-amazon-s3-free-version)

## Building the hierarchy locally

We'll create a hierarchy of folders actually designed to "host" not only our own current setup, but also several similar setups if needed.

Do you remember the **`my-fg-ovpn-s3`** sub-folder we created long ago ? That's what we'll use it for.

We'll begin by 2 folders at the top level : **`deploy`** and **`userdata`**

![](../.gitbook/assets/image%20%284%29.png)

Then within **`deploy`**, we'll create 3 sub-folders : **`conf`**, **`init`** and **`refresh`** like this :

![](../.gitbook/assets/image%20%2878%29.png)



## userdata NEEDS You  ! ðŸ‘‹ 

This folder will contain **one bootstrap file for each "configuration name"** that has an auto-configuration script : our own _**`my-fg-ovpn`**_ will shortly have one, so we'll give it a UserData file.

This type of file is in fact a set of shell commands executed by AWS EC2 "Instance" \(=a virtual server\) when it  boots for the first time.

So these files are like mini-shell scripts and we'll call them **`"configuration name"-userdata.sh`**

Let's look at the beginning of a sample file :

{% hint style="danger" %}
**You will NEED to customize the values at lines 4 to 6 according to your own choices**
{% endhint %}

{% code-tabs %}
{% code-tabs-item title="sample-conf-name-userdata.sh !! PARTIAL !!" %}
```bash
#!/bin/bash
echo `date` "UserData script starting - Args : $@"

export MY_STARTUP_CONFIG_NAME=your-configuration-name
export MY_STARTUP_S3_BUCKET=your-s3-bucket-name
export MY_STARTUP_VPNSubNet=10.10.10.0/24

```
{% endcode-tabs-item %}
{% endcode-tabs %}

{% hint style="danger" %}
**We have 2 \(or 3\) values here, that have to reflect the choices you made earlier :**

* **at line 4** you need to give **YOUR chosen "configuration name"**
* **at line 5** you need to give **the exact name of YOUR S3 bucket**
* **at line 6** you see the **VPN Private IP network**
{% endhint %}

### **The VPN private IP network**

Just like you have a private IP on your home network connection, when you are connected to the VPN you get another private IP with it, and that VPN private IP will be in the IP network of line 6 above.

{% hint style="danger" %}
You have to **check that the VPN private IP network does not overlap** with any of your _**other private IP networks**_ \(home/WIFI network, other VPNs you may be connected to...\)

**It also must not overlap with the AWS VPC CIDR that you noted before**
{% endhint %}

Most cases : 192.168.0.0/24 or 192.168.1.0/24 - 172.31.0.0/16

If needed, change the default 10.10.10.0/24 to any other free private /24





So, for our _**`my-fg-ovpn`**_ demo, the block above so that it looks like :

{% code-tabs %}
{% code-tabs-item title="my-fg-ovpn-userdata.sh - !! PARTIAL !!" %}
```bash
#!/bin/bash
echo `date` "UserData script starting - Args : $@"

export MY_STARTUP_CONFIG_NAME=your-configuration-name
export MY_STARTUP_S3_BUCKET=your-s3-bucket-name
export MY_STARTUP_VPNSubNet=10.10.10.0/24

```
{% endcode-tabs-item %}
{% endcode-tabs %}



#### Sample userdata file

Here is the **complete UserData file for a configuration called "sample-conf-name"**, that you will **copy/paste and rename+edit \(lines 4-6\)** so that it matches your own choices/requirements :

{% code-tabs %}
{% code-tabs-item title="sample-conf-name-userdata.sh" %}
```bash
#!/bin/bash
echo `date` "UserData script starting - Args : $@"

export MY_STARTUP_CONFIG_NAME=your-configuration-name
export MY_STARTUP_S3_BUCKET=your-s3-bucket-name
export MY_STARTUP_VPNSubNet=10.10.10.0/24

export MY_STARTUP_S3_DEPLOY_URL=s3://${MY_STARTUP_S3_BUCKET}/deploy

echo `date` "MY_FGVPN --- STARTUP CONFIG NAME   : ${MY_STARTUP_CONFIG_NAME}"
echo `date` "MY_FGVPN --- STARTUP VPN Subnet    : ${MY_STARTUP_VPNSubNet}"
echo `date` "MY_FGVPN --- STARTUP S3 Deploy URL : ${MY_STARTUP_S3_DEPLOY_URL}"

rm -rf /usr/local/${MY_STARTUP_CONFIG_NAME}
mkdir /usr/local/${MY_STARTUP_CONFIG_NAME}
mkdir /usr/local/${MY_STARTUP_CONFIG_NAME}/boot
mkdir /usr/local/${MY_STARTUP_CONFIG_NAME}/init

echo `date` "UserData script getting ${MY_STARTUP_CONFIG_NAME} init hierarchy from ${MY_FGVPN_S3_BUCKET} S3 bucket (from /deploy/init)"
echo `date` "THIS REQUIRES AN ASSIGNED EC2 ROLE"
aws s3 cp ${MY_STARTUP_S3_DEPLOY_URL}/init /usr/local/${MY_STARTUP_CONFIG_NAME}/init --recursive
chmod -R u+x /usr/local/${MY_STARTUP_CONFIG_NAME}/init/*.sh

echo `date` "UserData script building config vars sourcing script - /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs"
echo "export MY_FGVPN_CONFIG_NAME=${MY_STARTUP_CONFIG_NAME}" > /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo "export MY_FGVPN_VPNSubNet=${MY_STARTUP_VPNSubNet}" >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo "export MY_FGVPN_S3_BUCKET=${MY_STARTUP_S3_BUCKET}" >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo "export MY_FGVPN_S3_DEPLOY_URL=${MY_STARTUP_S3_DEPLOY_URL}" >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo 'echo `date` "MY_FGVPN --- CONFIG NAME   : ${MY_FGVPN_CONFIG_NAME}"' >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo 'echo `date` "MY_FGVPN --- VPN Subnet    : ${MY_FGVPN_VPNSubNet}"' >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs
echo 'echo `date` "MY_FGVPN --- S3 Deploy URL : ${MY_FGVPN_S3_DEPLOY_URL}"' >> /usr/local/${MY_STARTUP_CONFIG_NAME}/conf-specs

echo `date` "UserData script running ${MY_STARTUP_CONFIG_NAME}-init.sh"
/usr/local/${MY_STARTUP_CONFIG_NAME}/init/${MY_STARTUP_CONFIG_NAME}-init.sh
echo `date` "UserData script finished"
```
{% endcode-tabs-item %}
{% endcode-tabs %}



This is what the auto-setup script needs :

deploy/init

deploy/conf/config-name/

deploy/refresh/config-name/crl/







## Transfer Option 1 : Manual uploads



## Transfer Option 2 : CloudBerry Explorer for S3



